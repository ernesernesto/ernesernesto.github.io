<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>TLG Submission | ernesernesto io</title><meta property="og:title" content="TLG Submission | ernesernesto io"><meta name=twitter:title content="TLG Submission | ernesernesto io"><meta itemprop=name content="TLG Submission | ernesernesto io"><meta name=application-name content="TLG Submission | ernesernesto io"><meta property="og:site_name" content="ernesernesto.github.io"><meta name=description content="ernesernesto dev blog"><meta itemprop=description content="ernesernesto dev blog"><meta property="og:description" content="ernesernesto dev blog"><meta name=twitter:description content="ernesernesto dev blog"><meta property="og:locale" content="en-us"><meta name=language content="en-us"><meta itemprop=image content="http://ernesernesto.github.io/"><meta property="og:image" content="http://ernesernesto.github.io/"><meta name=twitter:image content="http://ernesernesto.github.io/"><meta name=twitter:image:src content="http://ernesernesto.github.io/"><meta name=generator content="Hugo 0.119.0"><link rel=canonical href=http://ernesernesto.github.io/writes/tlgsubmission/><link href=/style.min.9bd04d0fad85388343088ec85e9afd787ea003e72914d7f57df39c17ab2e7173.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=http://ernesernesto.github.io/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=http://ernesernesto.github.io/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class=menu-link href=/pages/reads/>Reads</a></li><li><a class="menu-link active" href=/writes/>Writes</a></li><li><a class=menu-link href=/pages/executes/>Executes</a></li><li><a class=menu-link href=/pages/info/>Info</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>TLG Submission</h1><div class=post-meta><time datetime=2024-05-09T10:05:31+07:00 itemprop=datePublished>May 9, 2024</time></div></header><div class=page-content><p>This blog post is a daily journal on setting up and finishing the test from Tavernlight Games</p><p>The test are generally broken down to two parts, first is testing your lua & cpp knowledge (Q1-Q4), the second part is creating feature on the forgotten server game (Q5-Q7). The person at Tavernlight Games were kind enough to provide with two links <a href=https://github.com/otland/forgottenserver>TFS server</a>, and <a href=https://github.com/edubart/otclient>OTC client</a> to play the game.</p><h2 id=first-part-q1---q4>First Part Q1 - Q4</h2><p>My knowledge on Lua leans more to practical scripting, I never investigate how it works under the hood, so before taking the task, I need to refresh up my Lua knowledge and also investigate Lua performance characteristics. From the looks of the question, I was expected to fix / improve the Lua implementation. So I dabbled around on Lua resource on the net for a refresher, to name a few <a href=http://lua-users.org/wiki/OptimisationTips>http://lua-users.org/wiki/OptimisationTips</a> and <a href=https://www.lua.org/gems/sample.pdf>https://www.lua.org/gems/sample.pdf</a></p><h3 id=q1>Q1</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=kr>function</span> <span class=nf>releaseStorage</span><span class=p>(</span><span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>player</span><span class=p>:</span><span class=n>setStorageValue</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>onLogout</span><span class=p>(</span><span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kr>if</span> <span class=n>player</span><span class=p>:</span><span class=n>getStorageValue</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>      <span class=n>addEvent</span><span class=p>(</span><span class=n>releaseStorage</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kr>end</span>
</span></span><span class=line><span class=cl>   <span class=kr>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>At first I thought that <strong>addEvent</strong> second parameter is also the parameter that is passed as an input to releaseStorage, since the 1000 values looks like a login status value. But after checking on the TLS source code, turns out the second param of <strong>addEvent</strong> is used as a delay in milliseconds, and player is the only parameter that is passed around. So I tried to make it clear that it is a player storage key and add a enum value so future keys could go into the <strong>PlayerStorageKeys</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- In this context, assuming this is a login logout logic so 1000 should be used as loginStatus</span>
</span></span><span class=line><span class=cl><span class=n>PlayerStorageKeys</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>loginStatus</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=c1>-- other keys for player can go below..</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=kr>function</span> <span class=nf>releaseStorage</span><span class=p>(</span><span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>player</span><span class=p>:</span><span class=n>setStorageValue</span><span class=p>(</span><span class=n>PlayerStorageKeys.loginStatus</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>onLogout</span><span class=p>(</span><span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kr>if</span> <span class=n>player</span><span class=p>:</span><span class=n>getStorageValue</span><span class=p>(</span><span class=n>PlayerStorageKeys.loginStatus</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>      <span class=n>addEvent</span><span class=p>(</span><span class=n>releaseStorage</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kr>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h3 id=q2>Q2</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>printSmallGuildNames</span><span class=p>(</span><span class=n>memberCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=c1>-- this method is supposed to print names of all guilds that have less than memberCount max members</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>selectGuildQuery</span> <span class=o>=</span> <span class=s2>&#34;SELECT name FROM guilds WHERE max_members &lt; %d;&#34;</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>resultId</span> <span class=o>=</span> <span class=n>db.storeQuery</span><span class=p>(</span><span class=n>string.format</span><span class=p>(</span><span class=n>selectGuildQuery</span><span class=p>,</span> <span class=n>memberCount</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>guildName</span> <span class=o>=</span> <span class=n>result.getString</span><span class=p>(</span><span class=s2>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>print</span><span class=p>(</span><span class=n>guildName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>I&rsquo;m not sure if the above query is correct, since I can&rsquo;t seem to find <strong>max_members</strong> on the guilds table using TFS 1.4 schema. The only available columns is id, <strong>name</strong>, <strong>ownerid</strong>, <strong>creationdata</strong>, <strong>motd</strong>, <strong>description</strong>, <strong>guild_logo</strong>, <strong>create_ip</strong>, and <strong>balance</strong>. But assuming <strong>max_members</strong> is available, the function become like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>printSmallGuildNames</span><span class=p>(</span><span class=n>memberCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>assert</span><span class=p>(</span><span class=n>type</span><span class=p>(</span><span class=n>memberCount</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;number&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>resultId</span> <span class=o>=</span> <span class=n>db.storeQuery</span><span class=p>(</span><span class=n>string.format</span><span class=p>(</span><span class=s2>&#34;SELECT `name` FROM `guilds` WHERE `max_members` &lt; %d&#34;</span><span class=p>,</span> <span class=n>memberCount</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=kr>if</span> <span class=ow>not</span> <span class=n>resultId</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>      <span class=n>print</span><span class=p>(</span><span class=s2>&#34;No guild found with member less than &#34;</span> <span class=o>..</span> <span class=n>tostring</span><span class=p>(</span><span class=n>memberCount</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=kr>else</span>
</span></span><span class=line><span class=cl>      <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Guild names&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>repeat</span>
</span></span><span class=line><span class=cl>         <span class=kd>local</span> <span class=n>guildName</span> <span class=o>=</span> <span class=n>result.getString</span><span class=p>(</span><span class=n>resultId</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=n>print</span><span class=p>(</span><span class=n>guildName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>until</span> <span class=ow>not</span> <span class=n>result.next</span><span class=p>(</span><span class=n>resultId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>result.free</span><span class=p>(</span><span class=n>resultId</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h3 id=q3>Q3</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>do_sth_with_PlayerParty</span><span class=p>(</span><span class=n>playerId</span><span class=p>,</span> <span class=n>membername</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>player</span> <span class=o>=</span> <span class=n>Player</span><span class=p>(</span><span class=n>playerId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>party</span> <span class=o>=</span> <span class=n>player</span><span class=p>:</span><span class=n>getParty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kr>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>party</span><span class=p>:</span><span class=n>getMembers</span><span class=p>())</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>      <span class=kr>if</span> <span class=n>v</span> <span class=o>==</span> <span class=n>Player</span><span class=p>(</span><span class=n>membername</span><span class=p>)</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>         <span class=n>party</span><span class=p>:</span><span class=n>removeMember</span><span class=p>(</span><span class=n>Player</span><span class=p>(</span><span class=n>membername</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=kr>end</span>
</span></span><span class=line><span class=cl>   <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>I renamed the function to make it clear what the function really is doing. Changed it into camelCase camelCase, some lua style guide use snake_case because of standard library but I use camelCase to make it consistent with the previous question. <strong>party:getMembers</strong> return array, so we need to check with <strong>ipairs</strong>. Lastly we remove the player from the party based on the <strong>membername</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>removePlayerFromParty</span><span class=p>(</span><span class=n>playerId</span><span class=p>,</span> <span class=n>membername</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>player</span> <span class=o>=</span> <span class=n>Player</span><span class=p>(</span><span class=n>playerId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>party</span> <span class=o>=</span> <span class=n>player</span><span class=p>:</span><span class=n>getParty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kr>if</span> <span class=n>party</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>      <span class=kr>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>member</span> <span class=kr>in</span> <span class=n>ipairs</span><span class=p>(</span><span class=n>party</span><span class=p>:</span><span class=n>getMembers</span><span class=p>())</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>         <span class=kd>local</span> <span class=n>checkName</span> <span class=o>=</span> <span class=n>member</span><span class=p>:</span><span class=n>getName</span><span class=p>()</span>
</span></span><span class=line><span class=cl>         <span class=kr>if</span> <span class=n>checkName</span> <span class=o>==</span> <span class=n>memberName</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>            <span class=n>party</span><span class=p>:</span><span class=n>removeMember</span><span class=p>(</span><span class=n>Player</span><span class=p>(</span><span class=n>membername</span><span class=p>))</span>
</span></span><span class=line><span class=cl>         <span class=kr>end</span>
</span></span><span class=line><span class=cl>      <span class=kr>end</span>
</span></span><span class=line><span class=cl>   <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h3 id=q4>Q4</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=n>Game</span><span class=o>::</span><span class=n>addItemToPlayer</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>recipient</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>itemId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Player</span> <span class=o>*</span><span class=n>player</span> <span class=o>=</span> <span class=n>g_game</span><span class=p>.</span><span class=n>getPlayerByName</span><span class=p>(</span><span class=n>recipient</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>player</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>player</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Player</span><span class=p>(</span><span class=k>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>IOLoginData</span><span class=o>::</span><span class=n>loadPlayerByName</span><span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>recipient</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Item</span> <span class=o>*</span><span class=n>item</span> <span class=o>=</span> <span class=n>Item</span><span class=o>::</span><span class=n>CreateItem</span><span class=p>(</span><span class=n>itemId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>item</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>g_game</span><span class=p>.</span><span class=n>internalAddItem</span><span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>getInbox</span><span class=p>(),</span> <span class=n>item</span><span class=p>,</span> <span class=n>INDEX_WHEREEVER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>FLAG_NOLIMIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>isOffline</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>IOLoginData</span><span class=o>::</span><span class=n>savePlayer</span><span class=p>(</span><span class=n>player</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>There are two answer that I tried on this question. One is deleting the player instance if <strong>getPlayerByName</strong> returning invalid ptr. The second is passing local player to &ldquo;fill&rdquo; values, so we don&rsquo;t need to allocate, this is a lot of assumptions given the above logic corner case handle giving item to an offline player. Most of the reason are commented below with the answers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// Answer 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Game</span><span class=o>::</span><span class=n>addItemToPlayer</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>recipient</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>itemId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Player</span> <span class=o>*</span><span class=n>player</span> <span class=o>=</span> <span class=n>g_game</span><span class=p>.</span><span class=n>getPlayerByName</span><span class=p>(</span><span class=n>recipient</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>player</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>player</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Player</span><span class=p>(</span><span class=k>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>IOLoginData</span><span class=o>::</span><span class=n>loadPlayerByName</span><span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>recipient</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>delete</span> <span class=n>player</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Item</span> <span class=o>*</span><span class=n>item</span> <span class=o>=</span> <span class=n>Item</span><span class=o>::</span><span class=n>CreateItem</span><span class=p>(</span><span class=n>itemId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>item</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Not sure if item also allocates after CreateItem above, but if it is, then
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// it *might* need to be freed if this function internalAddItem don&#39;t take
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ownership and simply copies item
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>g_game</span><span class=p>.</span><span class=n>internalAddItem</span><span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>getInbox</span><span class=p>(),</span> <span class=n>item</span><span class=p>,</span> <span class=n>INDEX_WHEREEVER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>FLAG_NOLIMIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>isOffline</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// From looking at the logic of the flow from the beginning of the function
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// it seems to assume that if player is logged in and online, it would never
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// allocate (g_game.getPlayerByName would return valid online player).
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Hence deleting the created player object only happens if player isOffline
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// but at that point, we could use loadPlayerByName to cache bool value so
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we don&#39;t check if player-&gt;isOffline again, assuming loadPlayerByName also
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// returns logged in user Not really sure about the flow of the function
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// here.. so at minimum player should be deleted here if it&#39;s deleted
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// outside here, it would risk always creating player object if the player
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// is online
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>IOLoginData</span><span class=o>::</span><span class=n>savePlayer</span><span class=p>(</span><span class=n>player</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>player</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Should be enabled if internalAddItem doesn&#39;t take ownership and copies Item
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// delete item;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Answer 2, alternatively, we could consider also doing this
</span></span></span><span class=line><span class=cl><span class=c1>// since player might just be used to fill &#34;values&#34;, so no need to allocate
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Game</span><span class=o>::</span><span class=n>addItemToPlayer</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>recipient</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>itemId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Player</span> <span class=n>tmpPlayer</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Player</span> <span class=o>*</span><span class=n>player</span> <span class=o>=</span> <span class=n>g_game</span><span class=p>.</span><span class=n>getPlayerByName</span><span class=p>(</span><span class=n>recipient</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>player</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>IOLoginData</span><span class=o>::</span><span class=n>loadPlayerByName</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tmpPlayer</span><span class=p>,</span> <span class=n>recipient</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>player</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>tmpPlayer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Item</span> <span class=o>*</span><span class=n>item</span> <span class=o>=</span> <span class=n>Item</span><span class=o>::</span><span class=n>CreateItem</span><span class=p>(</span><span class=n>itemId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>item</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>g_game</span><span class=p>.</span><span class=n>internalAddItem</span><span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>getInbox</span><span class=p>(),</span> <span class=n>item</span><span class=p>,</span> <span class=n>INDEX_WHEREEVER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>FLAG_NOLIMIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>isOffline</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>IOLoginData</span><span class=o>::</span><span class=n>savePlayer</span><span class=p>(</span><span class=n>player</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=second-part-setting-up-everything>Second Part Setting Up Everything</h2><p>This is a big writeup, mostly because I need to set up the server first. Upon reading the docs to setup the server, I need to also setup DB service to run alongside the server, in which TFS wiki recommends using <a href=https://www.uniformserver.com/>Uniform Server Zero</a>, apparently it&rsquo;s a web server which include a DB service and a db management tools.</p><p>So I grabbed and install the latest Uniform Server ZeroXV <a href=https://sourceforge.net/projects/miniserver/files>here</a>. Most of the steps to setup the server are already well explained <a href=https://docs.otland.net/ots-guide/running-your-first-ot-server/setting-up-your-first-server>here</a> so make sure to follow all steps on explained on the link.</p><p>One thing to note that, you need to use the <strong>schema.sql</strong> on the TFS github repo, I used the schema.sql from 1.4 forgotten server releases. After a succesfull import, your db should look like this.</p><p><img src=/tfs_imported_schema.png alt="TFS Imported Schema">.</p><p>Finally, rename <strong>config.lua.dist</strong> into <strong>config.lua</strong>, and edit <strong>mysqlUser</strong>, <strong>mysqlPass</strong>, and <strong>mysqlDatabase</strong> to the newly created db. Looks like all is good and ready, now try to run the TFS.exe again&mldr; but I got this error!</p><p><code>MySQL Error Message: Plugin caching_sha2_password could not be loaded:</code>
<code>The specified module could not be found. Library path is 'caching_sha2_password.dll',</code></p><p>Apparently latest MySql use a brand new authentication method that is not supported with TFS 1.4. In order to mitigate this, run query below</p><p><code>"ALTER USER 'yourusername'@'localhost' IDENTIFIED WITH mysql_native_password BY 'yourpassword';"</code>
Change <strong>yourusername</strong> and <strong>yourpassword</strong> with the one you use when setting up mysql.</p><p>After changing the default auth, try running the server executables again..
<img src=/tfs_running.png alt="TFS Server Running">
TFS server seems to be working correctly now!</p><p>No we need to create account and character in order to play the game. Continue following the steps on otland docs, I&rsquo;m using <a href=https://github.com/gesior/Gesior2012/tree/TFS-1.4>Gesior</a> since it seems to be the only correct AAC to work with TFS 1.4. After following the necessary create account steps, go ahead and open the www page of your localhost Gesior again, you&rsquo;ll be seeing this page.
<img src=/tfs_create_account.png alt="TFS Create Account"></p><p>Go ahead and create an account on that page.</p><p>Now it&rsquo;s time to build otclient, checkout otclient repo and build it following instructions <a href=https://github.com/edubart/otclient/wiki/Compiling-on-Windows>here</a>. When trying to compile the build on windows with visual studio 2022 on Release, I got this error</p><p><code>Cannot open include file: 'openssl/rsa.h': No such file or directory</code></p><p>Since I use vcpkg, this could be easily fixed by installing the package with <code>vcpkg install openssl-windows:x64-windows</code></p><p>After a successful build, go ahead and run the OTCClient exe, you&rsquo;ll be seeing this<br><img src=/tfs_otpclient.png alt="TFS OTClient"></p><p>Use the account name and password that you created on the Gesior page previously, Fill out the server and port (7171), and client version (1098), don&rsquo;t forget to <a href=https://github.com/EPuncker/1098extended>download the spr and dat files</a> and put them on the otpclient folder <strong>otpclient/data/things/1098/</strong></p><p>At this point, in order to play the game, you need to run the TFS server locally and use the OTClient to connect to your server, try to familiarize with the UI and the game first.</p><p>So while checking on the Q5-Q7, somehow I got the feeling that I should also compile TFS not using prereleased binary, on to try compiling the TFS then.
Instruction to compile TFS with vcpkg seems straightforward <a href=https://github.com/otland/forgottenserver/wiki/Compiling-on-Windows-%28vcpkg%29>here</a>, unfortunately tag v1.4, v1.4.1, and v1.4.2 all fails to compile, only master that could compiled easily, but running master is not suitable since it is using a different protocol with the current OTClient that I use, so I need to make 1.4 works.</p><p>There are a couple of issues, one linker error and two compile error.</p><p>The linker error is this
<code>1>cryptopp.lib(oaep.cpp.obj) : error LNK2001: unresolved external symbol __std_find_trivial_1</code>, so since TFS doesn&rsquo;t pin the libraries that it is used, vcpkg install will pull the latest version and that latest version doesn&rsquo;t work with TFS 1.4, this might be a bit of trouble in the future since another updated lib could potentially break the build.</p><p>Anyway.. <strong>cryptopp.lib</strong> needs to be pinned to a specific version, but of course <a href=https://github.com/microsoft/vcpkg/discussions/25622>there is no easy way to pin vcpkg library via command line</a>, good job vcpkg. Fix it by adding vcpkg.json on directory vc17, the version that I use for cryptopp.lib is 8.7.0.</p><p>Now there are two more compile error from <strong>iomapserialize.cpp</strong> and <strong>iomarket.cpp</strong>, both are coming from a combination of fmt lib and the compiler msvc version that is used, in order to quickly fix this, just replace those two files with the one from <a href=https://otland.net/threads/errors-when-compiling-tfs-v1-4x-v1-4-v1-4-1-v1-4-2.288569/post-2749377>here</a>;</p><p>Congrats! Now you could change the server yourself! Now on to finally finishing Q5 to Q7</p><h2 id=second-part-q5-q7>Second Part Q5-Q7</h2><h3 id=q5>Q5</h3><p>Creating a spells is quite straightforward, I just need to add new entry on spells.xml and implement the spell with what I wanted. For the <strong>spellid</strong> value I pick it&rsquo;s value that is not conflicting with other already defined <strong>spellid</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;spells&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;instant</span> <span class=na>group=</span><span class=s>&#34;attack&#34;</span> <span class=na>spellid=</span><span class=s>&#34;200&#34;</span> <span class=na>name=</span><span class=s>&#34;Wind Tornado&#34;</span> <span class=na>words=</span><span class=s>&#34;frigo&#34;</span> <span class=na>level=</span><span class=s>&#34;1&#34;</span> <span class=na>mana=</span><span class=s>&#34;0&#34;</span> <span class=na>premium=</span><span class=s>&#34;1&#34;</span> <span class=na>selftarget=</span><span class=s>&#34;1&#34;</span> <span class=na>cooldown=</span><span class=s>&#34;10&#34;</span> <span class=na>groupcooldown=</span><span class=s>&#34;10&#34;</span> <span class=na>needlearn=</span><span class=s>&#34;0&#34;</span> <span class=na>script=</span><span class=s>&#34;attack/wind_tornado.lua&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/spells&gt;</span>
</span></span></code></pre></div><p>For the Lua implementation, I created a big combat area for the spells to target. If I use ICETORNADO, the spells spawned doesn&rsquo;t seem to actually correctly target the combat area, so I need to adjust it one by one. The gist of the logic is <strong>onCastSpell</strong>, it will trigger <strong>onTargetTile</strong> callback in which it would send the magic effect 5 times with random delay with the help of <strong>addEvent</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>area</span> <span class=o>=</span> <span class=n>createCombatArea</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>spellCallback</span><span class=p>(</span><span class=n>cid</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>if</span> <span class=n>Creature</span><span class=p>(</span><span class=n>cid</span><span class=p>)</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>		<span class=kr>if</span> <span class=n>count</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>math.random</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>			<span class=n>position</span><span class=p>:</span><span class=n>sendMagicEffect</span><span class=p>(</span><span class=n>CONST_ME_ICETORNADO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>doAreaCombat</span><span class=p>(</span><span class=n>cid</span><span class=p>,</span> <span class=n>COMBAT_ICEDAMAGE</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=n>CONST_ME_ICETORNADO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kr>if</span> <span class=n>count</span> <span class=o>&lt;</span> <span class=mi>5</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>			<span class=n>count</span> <span class=o>=</span> <span class=n>count</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>			<span class=n>addEvent</span><span class=p>(</span><span class=n>spellCallback</span><span class=p>,</span> <span class=n>math.random</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span> <span class=n>cid</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=kr>end</span>
</span></span><span class=line><span class=cl>	<span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>onTargetTile</span><span class=p>(</span><span class=n>creature</span><span class=p>,</span> <span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>spellCallback</span><span class=p>(</span><span class=n>creature</span><span class=p>:</span><span class=n>getId</span><span class=p>(),</span> <span class=n>position</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>combat</span> <span class=o>=</span> <span class=n>Combat</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>combat</span><span class=p>:</span><span class=n>setArea</span><span class=p>(</span><span class=n>area</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>combat</span><span class=p>:</span><span class=n>setCallback</span><span class=p>(</span><span class=n>CALLBACK_PARAM_TARGETTILE</span><span class=p>,</span> <span class=s2>&#34;onTargetTile&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>onCastSpell</span><span class=p>(</span><span class=n>creature</span><span class=p>,</span> <span class=n>variant</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>return</span> <span class=n>combat</span><span class=p>:</span><span class=n>execute</span><span class=p>(</span><span class=n>creature</span><span class=p>,</span> <span class=n>variant</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>The spells above trigger with <strong>frigo</strong>, to make it easy to test, I set it to level 1 with no mana requirement and low cooldown. See the spells in action on the video below</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/l7yjoKy8hc0 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h3 id=q6>Q6</h3><p>This is a tough one, since from the example video I need to implement changes on both TFS and the OTClient, on TFS I need a way to hook into movement callback, in OTClient side I need to implement shaders for the mirage effect. In order to test the movement, first I created a spell that would move the player, and according to the player direction, it will then try to move until it cannot move anymore. All seems to be working as expected, but it&rsquo;s a little cumbersome since we need to execute the spell before the movement effect will happen.</p><p>I tried to look around the code to find where I could implement the movement callback, on TFS 1.4 there are no callback that can handle movement of player, so I need to implement one. I went ahead and add a new <strong>EVENT_CALLBACK</strong> on <strong>event_callbacks.lua</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>EVENT_CALLBACK_ONMOVE</span> <span class=o>=</span> <span class=mi>19</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>---</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s2>&#34;onMove&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>EVENT_CALLBACK_ONMOVE</span><span class=p>,</span>
</span></span></code></pre></div><p>adding that and adjusting the rest of the callback values since it&rsquo;s now shifted. After that add a new player event on <strong>events.xml</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>   <span class=nt>&lt;event</span> <span class=na>class=</span><span class=s>&#34;Player&#34;</span> <span class=na>method=</span><span class=s>&#34;onMove&#34;</span> <span class=na>enabled=</span><span class=s>&#34;1&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></div><p>Now on events.h and events.cpp we will need to add a new function entry to handle onMove.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//events.h
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int32_t</span> <span class=n>playerOnMove</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>eventPlayerOnMove</span><span class=p>(</span><span class=n>Player</span><span class=o>*</span> <span class=n>player</span><span class=p>,</span> <span class=k>const</span> <span class=n>Position</span><span class=o>&amp;</span> <span class=n>position</span><span class=p>,</span> <span class=n>Direction</span> <span class=n>direction</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//events.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Events</span><span class=o>::</span><span class=n>eventPlayerOnMove</span><span class=p>(</span><span class=n>Player</span> <span class=o>*</span><span class=n>player</span><span class=p>,</span> <span class=k>const</span> <span class=n>Position</span> <span class=o>&amp;</span><span class=n>position</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>Direction</span> <span class=n>direction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Player:onMove(position, direction) or Player.onMove(self,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// position, direaction)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>playerOnMove</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>scriptInterface</span><span class=p>.</span><span class=n>reserveScriptEnv</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;[Error - Events::eventPlayerOnMove] Call stack overflow&#34;</span>
</span></span><span class=line><span class=cl>	            <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ScriptEnvironment</span> <span class=o>*</span><span class=n>env</span> <span class=o>=</span> <span class=n>scriptInterface</span><span class=p>.</span><span class=n>getScriptEnv</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>env</span><span class=o>-&gt;</span><span class=n>setScriptId</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>playerOnMove</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>scriptInterface</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>lua_State</span> <span class=o>*</span><span class=n>L</span> <span class=o>=</span> <span class=n>scriptInterface</span><span class=p>.</span><span class=n>getLuaState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>scriptInterface</span><span class=p>.</span><span class=n>pushFunction</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>playerOnMove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>LuaScriptInterface</span><span class=o>::</span><span class=n>pushUserdata</span><span class=o>&lt;</span><span class=n>Player</span><span class=o>&gt;</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>player</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>LuaScriptInterface</span><span class=o>::</span><span class=n>setMetatable</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Player&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>LuaScriptInterface</span><span class=o>::</span><span class=n>pushPosition</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>position</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>lua_pushnumber</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>direction</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>scriptInterface</span><span class=p>.</span><span class=n>callVoidFunction</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>On the Lua side, we also need to add a new hook to handle onMove, add this changes to player.lua</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nc>Player</span><span class=p>:</span><span class=nf>onMove</span><span class=p>(</span><span class=n>position</span><span class=p>,</span> <span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>if</span> <span class=n>hasEventCallback</span><span class=p>(</span><span class=n>EVENT_CALLBACK_ONMOVE</span><span class=p>)</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>		<span class=n>EventCallback</span><span class=p>(</span><span class=n>EVENT_CALLBACK_ONMOVE</span><span class=p>,</span> <span class=n>self</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>We then need to call the function on the cpp side to trigger the onMove event, on game.cpp, add the event callback on function internalMoveCreature, we need to also check if it&rsquo;s actually the player that doing the movement.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ReturnValue</span> <span class=n>Game</span><span class=o>::</span><span class=n>internalMoveCreature</span><span class=p>(</span><span class=n>Creature</span><span class=o>&amp;</span> <span class=n>creature</span><span class=p>,</span> <span class=n>Tile</span><span class=o>&amp;</span> <span class=n>toTile</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>flags</span> <span class=cm>/*= 0*/</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>/// omitted for brevity
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=n>map</span><span class=p>.</span><span class=n>moveCreature</span><span class=p>(</span><span class=n>creature</span><span class=p>,</span> <span class=n>toTile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>Player</span><span class=o>*</span> <span class=n>player</span> <span class=o>=</span> <span class=n>creature</span><span class=p>.</span><span class=n>getPlayer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Position</span> <span class=n>fromPosition</span> <span class=o>=</span> <span class=n>player</span><span class=o>-&gt;</span><span class=n>getTile</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getPosition</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>Direction</span> <span class=n>direction</span> <span class=o>=</span> <span class=n>player</span><span class=o>-&gt;</span><span class=n>getDirection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>g_events</span><span class=o>-&gt;</span><span class=n>eventPlayerOnMove</span><span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>fromPosition</span><span class=p>,</span> <span class=n>direction</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div><p>Now finally, we need to implement the Lua callback that will handle the onMove callback. Add player_onMove.lua on data\scripts\eventcallbacks\player</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>ec</span> <span class=o>=</span> <span class=n>EventCallback</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>outfit</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ec.onMove</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>position</span><span class=p>:</span><span class=n>getNextPosition</span><span class=p>(</span><span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>local</span> <span class=n>toTile</span> <span class=o>=</span> <span class=n>Tile</span><span class=p>(</span><span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>while</span> <span class=n>toTile</span> <span class=ow>and</span> <span class=n>toTile</span><span class=p>:</span><span class=n>isWalkable</span><span class=p>()</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=p>:</span><span class=n>sendMagicEffect</span><span class=p>(</span><span class=n>CONST_ME_POFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>self</span><span class=p>:</span><span class=n>teleportTo</span><span class=p>(</span><span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=p>:</span><span class=n>getNextPosition</span><span class=p>(</span><span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>toTile</span> <span class=o>=</span> <span class=n>Tile</span><span class=p>(</span><span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ec</span><span class=p>:</span><span class=n>register</span><span class=p>()</span>
</span></span></code></pre></div><p>For the most part, the movement callback is done, now we move on to implement the shader.
Unfortunately, I found no easy way to duplicate the effects demonstrated on the example. I tried on the OTClient cpp code calling multiple <strong>internalDrawOutfit()</strong> after a move event but the effect is not on the quality I want to achieve. There should also be a way to do a custom shader via creating a new shader on <strong>shadermanager.cpp</strong>, and invoking it via <strong>sendMagicEffect</strong> from Lua, but I can&rsquo;t find a way to hook up <strong>Effect::drawEffect</strong> to use the shader and access the creature outfit draw buffer to correctly draw it with a different offset and opacity, it all ends down to <strong>rawGetThingType->draw()</strong> which cannot be set with it&rsquo;s type easily.</p><p>So at this point any attempt on the shader would ends up hacky and improper, so after a lot of consideration, I decided to implement it from Lua onMove callback to add some effect. <strong>player_onMove.lua</strong> after the added effect changes would look like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>ec</span> <span class=o>=</span> <span class=n>EventCallback</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>outfit</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ec.onMove</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>position</span><span class=p>:</span><span class=n>getNextPosition</span><span class=p>(</span><span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>local</span> <span class=n>toTile</span> <span class=o>=</span> <span class=n>Tile</span><span class=p>(</span><span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>while</span> <span class=n>toTile</span> <span class=ow>and</span> <span class=n>toTile</span><span class=p>:</span><span class=n>isWalkable</span><span class=p>()</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=p>:</span><span class=n>sendMagicEffect</span><span class=p>(</span><span class=n>CONST_ME_POFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>self</span><span class=p>:</span><span class=n>teleportTo</span><span class=p>(</span><span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>position</span><span class=p>:</span><span class=n>getNextPosition</span><span class=p>(</span><span class=n>direction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>toTile</span> <span class=o>=</span> <span class=n>Tile</span><span class=p>(</span><span class=n>position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>outfit</span> <span class=o>=</span> <span class=n>self</span><span class=p>:</span><span class=n>getOutfit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>rainbowEffect</span><span class=p>(</span><span class=n>self</span><span class=p>:</span><span class=n>getId</span><span class=p>(),</span> <span class=n>outfit.lookType</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ec</span><span class=p>:</span><span class=n>register</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>rainbowEffect</span><span class=p>(</span><span class=n>cid</span><span class=p>,</span> <span class=n>lookType</span><span class=p>,</span> <span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>local</span> <span class=n>creature</span> <span class=o>=</span> <span class=n>Creature</span><span class=p>(</span><span class=n>cid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>if</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>		<span class=kd>local</span> <span class=n>colors</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>94</span><span class=p>,</span> <span class=mi>77</span><span class=p>,</span> <span class=mi>79</span><span class=p>,</span> <span class=mi>82</span><span class=p>,</span> <span class=mi>87</span><span class=p>,</span> <span class=mi>90</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>creature</span><span class=p>:</span><span class=n>setOutfit</span><span class=p>({</span>
</span></span><span class=line><span class=cl>			<span class=n>lookType</span> <span class=o>=</span> <span class=n>lookType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>lookHead</span> <span class=o>=</span> <span class=n>colors</span><span class=p>[((</span><span class=n>index</span><span class=p>)</span> <span class=o>%</span> <span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=n>lookBody</span> <span class=o>=</span> <span class=n>colors</span><span class=p>[((</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=n>lookLegs</span> <span class=o>=</span> <span class=n>colors</span><span class=p>[((</span><span class=n>index</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>%</span> <span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=n>lookFeet</span> <span class=o>=</span> <span class=n>colors</span><span class=p>[((</span><span class=n>index</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>%</span> <span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=n>addEvent</span><span class=p>(</span><span class=n>rainbowEffect</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=n>cid</span><span class=p>,</span> <span class=n>lookType</span><span class=p>,</span> <span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>else</span>
</span></span><span class=line><span class=cl>		<span class=n>creature</span><span class=p>:</span><span class=n>setOutfit</span><span class=p>(</span><span class=n>outfit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>I added rainbowEffect which will set the creature outfit randomly 3 times with different color before finally setting it back to it&rsquo;s initial color.</p><p>Video for the result is below.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/XvMfxb2GPQU style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h3 id=q7>Q7</h3><p>Following tutorial on <a href=https://github.com/edubart/otclient/wiki/Module-Tutorial#creating-a-new-module>here</a> I was able to create a new module for OTClient. In order to do this, I need to make 3 files <strong>.lua</strong>, <strong>.otmod</strong> and <strong>.otui</strong> files. All of this is done on OTClient side. First, we create the <strong>.otmod</strong> file which is a register files that would hook up the lua script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>Module</span>
</span></span><span class=line><span class=cl>  <span class=nt>name</span><span class=o>:</span> <span class=nt>client_jumpwindow</span>
</span></span><span class=line><span class=cl>  <span class=nt>description</span><span class=o>:</span> <span class=nt>Jump</span> <span class=nt>Window</span>
</span></span><span class=line><span class=cl>  <span class=nt>author</span><span class=o>:</span> <span class=nt>ernesernesto</span>
</span></span><span class=line><span class=cl>  <span class=nt>website</span><span class=o>:</span> <span class=nt>-</span>
</span></span><span class=line><span class=cl>  <span class=nt>version</span><span class=o>:</span> <span class=nt>1</span>
</span></span><span class=line><span class=cl>  <span class=nt>sandboxed</span><span class=o>:</span> <span class=nt>true</span>
</span></span><span class=line><span class=cl>  <span class=nt>scripts</span><span class=o>:</span> <span class=o>[</span> <span class=nt>jumpwindow</span><span class=p>.</span><span class=nc>lua</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=p>@</span><span class=k>onLoad</span><span class=o>:</span> <span class=nt>init</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=p>@</span><span class=k>onUnload</span><span class=o>:</span> <span class=nt>terminate</span><span class=o>()</span>
</span></span></code></pre></div><p>sandboxed mean the script won&rsquo;t pollute the global lua env, so in theory we don&rsquo;t need to local every function declaration / variables. This otmod file would use <strong>jumpwindow.lua</strong>, and at onLoad it will call <strong>init()</strong> and <strong>onUnload</strong> it will call t<strong>erminate()</strong>.</p><p>For the <strong>otui</strong> file, it is used as a way to declare your ui, see it as a layouting descriptor files just like css on web. The contents itself is self explanatory. We have a window derived from MainWindow, with window title Jump, and one Button with id <strong>jumpButton</strong> and text Jump. When the button is click it will call <strong>onClickButton()</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>MainWindow</span>
</span></span><span class=line><span class=cl>  <span class=o>!</span><span class=nt>text</span><span class=o>:</span> <span class=nt>tr</span><span class=o>(</span><span class=s1>&#39;Jump&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nt>size</span><span class=o>:</span> <span class=nt>450</span> <span class=nt>450</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>Button</span>
</span></span><span class=line><span class=cl>    <span class=nt>id</span><span class=o>:</span> <span class=nt>jumpButton</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nt>text</span><span class=o>:</span> <span class=nt>tr</span><span class=o>(</span><span class=s1>&#39;Jump!&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nt>width</span><span class=o>:</span> <span class=nt>90</span>
</span></span><span class=line><span class=cl>    <span class=p>@</span><span class=k>onClick</span><span class=o>:</span> <span class=nt>onClickButton</span><span class=o>()</span>
</span></span></code></pre></div><p>Finally here is the content of lua file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>jumpWindow</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=n>jumpWindowButton</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=n>jumpButton</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>windowPos</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=n>windowSize</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=n>buttonSize</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span> <span class=o>=</span> <span class=n>g_ui.displayUI</span><span class=p>(</span><span class=s1>&#39;jumpwindow.otui&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span><span class=p>:</span><span class=n>hide</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindowButton</span> <span class=o>=</span> <span class=n>modules.client_topmenu</span><span class=p>.</span><span class=n>addLeftButton</span><span class=p>(</span><span class=s1>&#39;jumpWindowButton&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tr</span><span class=p>(</span><span class=s1>&#39;Jump Window&#39;</span><span class=p>),</span> <span class=s1>&#39;/client_jumpwindow/jumpwindow&#39;</span><span class=p>,</span> <span class=n>toggle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpButton</span> <span class=o>=</span> <span class=n>jumpWindow</span><span class=p>:</span><span class=n>getChildById</span><span class=p>(</span><span class=s1>&#39;jumpButton&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>windowSize</span> <span class=o>=</span> <span class=n>jumpWindow</span><span class=p>:</span><span class=n>getSize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>buttonSize</span> <span class=o>=</span> <span class=n>jumpButton</span><span class=p>:</span><span class=n>getSize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>cycleEvent</span><span class=p>(</span><span class=n>updatePos</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>terminate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindowButton</span><span class=p>:</span><span class=n>destroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>toggle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=n>jumpWindow</span><span class=p>:</span><span class=n>isVisible</span><span class=p>()</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>hide</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kr>else</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>hide</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span><span class=p>:</span><span class=n>hide</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span><span class=p>:</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span><span class=p>:</span><span class=n>raise</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>jumpWindow</span><span class=p>:</span><span class=n>focus</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>updatePos</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>windowPos</span> <span class=o>=</span> <span class=n>jumpWindow</span><span class=p>:</span><span class=n>getPosition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pos</span> <span class=o>=</span> <span class=n>jumpButton</span><span class=p>:</span><span class=n>getPosition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>pos.x</span> <span class=o>=</span> <span class=n>pos.x</span> <span class=o>-</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=n>pos.x</span> <span class=o>&lt;</span> <span class=n>windowPos.x</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>pos.x</span> <span class=o>=</span> <span class=n>windowPos.x</span> <span class=o>+</span> <span class=n>windowSize.width</span> <span class=o>-</span> <span class=n>buttonSize.width</span>
</span></span><span class=line><span class=cl>    <span class=n>pos.y</span> <span class=o>=</span> <span class=n>pos.y</span> <span class=o>-</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>  <span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pos.y</span> <span class=o>=</span> <span class=n>clampButtonYPos</span><span class=p>(</span><span class=n>pos.y</span><span class=p>,</span> <span class=n>windowPos.y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jumpButton</span><span class=p>:</span><span class=n>setPosition</span><span class=p>(</span><span class=n>pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>onClickButton</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>windowPos</span> <span class=o>=</span> <span class=n>jumpWindow</span><span class=p>:</span><span class=n>getPosition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pos</span> <span class=o>=</span> <span class=n>jumpButton</span><span class=p>:</span><span class=n>getPosition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>pos.y</span> <span class=o>=</span> <span class=n>pos.y</span> <span class=o>-</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>  <span class=n>pos.y</span> <span class=o>=</span> <span class=n>clampButtonYPos</span><span class=p>(</span><span class=n>pos.y</span><span class=p>,</span> <span class=n>windowPos.y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>jumpButton</span><span class=p>:</span><span class=n>setPosition</span><span class=p>(</span><span class=n>pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>clampButtonYPos</span><span class=p>(</span><span class=n>yPos</span><span class=p>,</span> <span class=n>windowYPos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=n>yPos</span> <span class=o>-</span> <span class=mi>100</span> <span class=o>&lt;</span> <span class=n>windowYPos</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>yPos</span> <span class=o>=</span> <span class=n>windowYPos</span> <span class=o>+</span> <span class=n>windowSize.height</span> <span class=o>-</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>  <span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>return</span> <span class=n>yPos</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>First, we need a way to show the jumpWindow window on the main OTClient. This is done by calling</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl>  <span class=n>jumpWindowButton</span> <span class=o>=</span> <span class=n>modules.client_topmenu</span><span class=p>.</span><span class=n>addLeftButton</span><span class=p>(</span><span class=s1>&#39;jumpWindowButton&#39;</span><span class=p>,</span> <span class=n>tr</span><span class=p>(</span><span class=s1>&#39;Jump Window&#39;</span><span class=p>),</span> <span class=s1>&#39;/client_jumpwindow/jumpwindow&#39;</span><span class=p>,</span> <span class=n>toggle</span><span class=p>)</span>
</span></span></code></pre></div><p>Clicking the jumpWindowButton would then call <strong>toggle</strong> function.
We will implement <strong>onClickButton</strong> hook when the jump button inside jumpWindow is clicked. We do this by calling</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl>  <span class=n>jumpButton</span><span class=p>:</span><span class=n>setPosition</span><span class=p>()</span>
</span></span></code></pre></div><p>Finally, to make the jumpButton update, we use <strong>cycleEvent</strong> which will update the position of the button on 50ms interval.
To view the result in action, see video below</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/p9QPxIn2PzQ style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><p>Thank you for reading this far! For complete code changes history, please see the github repo <a href=https://github.com/ernesernesto/tlg>here</a></p></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/ernesernesto target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/ernesernesto target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2024 .
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg></a><script src=http://ernesernesto.github.io/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>