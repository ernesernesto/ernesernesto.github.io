<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Debugging Memory Allocation | ernesernesto io</title><meta property="og:title" content="Debugging Memory Allocation | ernesernesto io"><meta name=twitter:title content="Debugging Memory Allocation | ernesernesto io"><meta itemprop=name content="Debugging Memory Allocation | ernesernesto io"><meta name=application-name content="Debugging Memory Allocation | ernesernesto io"><meta property="og:site_name" content="ernesernesto.github.io"><meta name=description content="ernesernesto dev blog"><meta itemprop=description content="ernesernesto dev blog"><meta property="og:description" content="ernesernesto dev blog"><meta name=twitter:description content="ernesernesto dev blog"><meta property="og:locale" content="en-us"><meta name=language content="en-us"><meta itemprop=image content="http://ernesernesto.github.io/"><meta property="og:image" content="http://ernesernesto.github.io/"><meta name=twitter:image content="http://ernesernesto.github.io/"><meta name=twitter:image:src content="http://ernesernesto.github.io/"><meta name=generator content="Hugo 0.119.0"><link rel=canonical href=http://ernesernesto.github.io/writes/debuggingmemoryallocations/><link href=/style.min.9bd04d0fad85388343088ec85e9afd787ea003e72914d7f57df39c17ab2e7173.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=http://ernesernesto.github.io/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=http://ernesernesto.github.io/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class=menu-link href=/pages/reads/>Reads</a></li><li><a class="menu-link active" href=/writes/>Writes</a></li><li><a class=menu-link href=/pages/executes/>Executes</a></li><li><a class=menu-link href=/pages/info/>Info</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Debugging Memory Allocation</h1><div class=post-meta><time datetime=2018-04-16T12:00:00+07:00 itemprop=datePublished>Apr 16, 2018</time></div></header><div class=page-content><p>Recently I was debugging some particular nasty bugs that happens on memory allocations, the intricate part is, it happens infrequently
My app was crashing on a release build more frequently than in debug builds.</p><p>I was doing some manual memory allocations, at the start of the app it will load a saved data from a file into that memory. The app was doing fine until I started to write something to the saved data, then on the next launch it will start to crash intermittently on release build.</p><p>I was using the technique explained on Handmadehero, for some of you who didn’t know, Handmadehero is a programming stream in which Casey Muratori aimed to teach a complete game live, no engines, no libraries, created from scratch, one hour a day, and currently with 400+ episodes so far.</p><p>So doing the allocations Handmadehero-style, memory allocations happens at the start of the app, preallocated for a specific size.</p><p>This gains many benefit in which we don’t need to handle newing and deleting memory every time, and particularly dealing with memory fragmentations, I’ll talk more about this later.</p><p>Also in the case that our app reach the memory limit that we set, we could take two approach, either allocating bigger size at the start of the application or use loading unloading mechanism (ex. filling old address of memory with new block of data). By using this technique, we also put a framework in mind to work with by making sure our app doesn’t hit the size limit, since we know that it will crash with out of memory if we don’t have enough room.</p><h3 id=preallocated-memory-allocations>Preallocated Memory Allocations</h3><p>So the entirety of the bug is this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Resource</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>b32</span> <span class=n>processing</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r64</span> <span class=n>timeRemaining</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>OwnedResource</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>toProduceCount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>b32</span> <span class=n>owned</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>b32</span> <span class=n>pad_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>AppData</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>pad_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>pad_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>OwnedResource</span><span class=o>*</span> <span class=n>owned</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>*</span> <span class=n>resources</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The Entirety of The Bug
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>MemoryArena</span> <span class=n>arena</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>memSize</span> <span class=o>=</span> <span class=nf>Megabytes</span><span class=p>(</span><span class=mi>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>memory</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>memSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arena</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>memSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>arena</span><span class=p>.</span><span class=n>base</span> <span class=o>=</span> <span class=p>(</span><span class=n>u8</span><span class=o>*</span><span class=p>)</span><span class=n>memory</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>arena</span><span class=p>.</span><span class=n>used</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>AppData</span><span class=o>*</span> <span class=n>appData</span> <span class=o>=</span> <span class=nf>pushStruct</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>AppData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>appData</span><span class=o>-&gt;</span><span class=n>owned</span> <span class=o>=</span> <span class=nf>pushArray</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>ResourceType_Count</span><span class=p>,</span> <span class=n>OwnedResource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>appData</span><span class=o>-&gt;</span><span class=n>resources</span> <span class=o>=</span> <span class=nf>pushArray</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>ResourceType_Count</span><span class=p>,</span> <span class=n>Resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span><span class=o>*</span> <span class=n>dataFile</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;file.dat&#34;</span><span class=p>,</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>dataFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>AppData</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Crash happens here
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>owned</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>OwnedResource</span><span class=p>)</span><span class=o>*</span><span class=n>ResourceType_Count</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>resources</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Resource</span><span class=p>)</span><span class=o>*</span><span class=n>ResourceType_Count</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fclose</span><span class=p>(</span><span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see I aligned all of my structs so it will be 8 byte aligned with a pad, if you don’t aligned those data, serializing back and forth is erroneous since memory works with alignment.
<code>u32</code> <code>b32</code> <code>r64</code> is an alias for unsigned/bool/real followed with its size.</p><p>At first the app allocated a linearly contiguous 32mb sized memory, then it starts to <code>pushStruct</code> and <code>pushArrays</code> into the memory arena. With this the memory is always contiguous and laids out linearly inside the arena, not distributed all over the place in the case where we do a <code>new</code> each time we need a data stored on heap.</p><p>Crash happens more frequently on release builds. On debug build, the only information that I got when crashing was the address of appData->owned is invalid.</p><p>The address of <code>appData</code>, <code>appData->owned</code> and <code>appData->resources</code> should be adjacent to each other, they happen to be pushed to the memory sequentially. If <code>appData</code> is located on <code>0x00000000</code> and <code>sizeof(AppData)</code> is 40, then <code>appData->owned</code> should start at <code>0x00000028</code></p><p>But as it turns out the address of <code>appData->owned</code> and <code>appData->resources</code> points to invalid memory address and that address is particularly big.</p><p>For the avid readers you could already see why the bug happens given the information I give above.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define pushStruct(arena, type, ...) (type*)arena-&gt;pushSize_(sizeof(type), ## __VA_ARGS__)
</span></span></span><span class=line><span class=cl><span class=cp>#define pushArray(arena, count, type, ...) (type*)arena-&gt;pushSize_((count)*sizeof(type), ## __VA_ARGS__)
</span></span></span><span class=line><span class=cl><span class=cp>#define pushSize(arena, size, ...) arena-&gt;pushSize_(size, ## __VA_ARGS__) 
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>MemoryArena</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>used</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span><span class=o>*</span> <span class=n>base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=nf>getAlignmentOffset</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>alignment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>alignmentOffset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>pointer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=n>base</span> <span class=o>+</span> <span class=n>used</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>alignmentMask</span> <span class=o>=</span> <span class=n>alignment</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>pointer</span> <span class=o>&amp;</span> <span class=n>alignmentMask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>alignmentOffset</span> <span class=o>=</span> <span class=n>alignment</span> <span class=o>-</span> <span class=p>(</span><span class=n>pointer</span> <span class=o>&amp;</span> <span class=n>alignmentMask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>alignmentOffset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=nf>pushSize_</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>inSize</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>alignment</span><span class=cm>/* = 8*/</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>alignmentOffset</span> <span class=o>=</span> <span class=nf>getAlignmentOffset</span><span class=p>(</span><span class=n>alignment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>inSize</span> <span class=o>+=</span> <span class=n>alignmentOffset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span><span class=o>*</span> <span class=n>result</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>used</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>used</span> <span class=o>+=</span> <span class=n>inSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Everytime we do a <code>pushStruct</code> or <code>pushArrays</code>, first we need to check if the data that we’re pushing is aligned on the alignment boundary. If not, we’re
adding an offset to the end of the last pushed data. With this all write and reads to the memory guaranteed to be aligned with how the memory access it. It should not be happening because of alignment I guess, but why on the release build happens more frequently then?</p><p>&mldr;</p><h3 id=making-wrong-assumptions>Making Wrong Assumptions</h3><p>I tried changing the default alignment param for <code>pushSize_</code> from 8, to 4 and 16. Tested both on release and debug builds. Nothing changes, everything works until the first time I write the save data, then the next launch still crashes.</p><p>Then I tried not adding the <code>alignmentOffset</code> to the size, just to make sure.
Since I properly aligned all my data structs, it should still works correctly with my MacBook Pro 2015, that should be 64bit aligned right? But just to make sure since I use XCode and I don’t know what black secret magic compilations and optimizations that they’re used behind the scene, it could messed up my alignment or so I think. But still, no changes with the behavior of the bug.</p><p>At the very end I tried not to use the preallocated memory, but each data that is pushed is returned using malloced memory, and then the bug suddenly disappears.</p><p>Whoa if the bug disappears using <code>malloc</code>, then this defeats the purpose of using linear contiguos memory, preallocated on the beginning, since malloced memory happens to make the app works correctly. It should not be this way, I don’t want the idea of using <code>malloc</code> every time I need to allocate a memory, this is the same as using new. The only difference is that <code>new</code> allocate and init a memory while malloc only allocates it, grabs a sized memory and returned anything that is inside it, non-initialized.</p><p>So what is it that makes the <code>malloc</code> version works then? I thought for a bit. The difference between those two are one is linearly contiguous and the other address is distributed all over the place. Why is the idea of the address not adjacent to each other works then?</p><p>Then it hits me hard.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>AppData</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>pad_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>pad_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>OwnedResource</span><span class=o>*</span> <span class=n>owned</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>*</span> <span class=n>resources</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>AppData</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Crash happens here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>owned</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>OwnedResource</span><span class=p>)</span><span class=o>*</span><span class=n>ResourceType_Count</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>resources</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Resource</span><span class=p>)</span><span class=o>*</span><span class=n>ResourceType_Count</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Reading appData with <code>sizeof(AppData)</code>, in this case it’s 40, also includes the data address inside <code>owned</code> and <code>resources</code>. So on the first run before we do a save data it will always works since the data is empty. But the next run after the save data is written, the address of those two pointers also gets written. Thus reading 40 bytes into <code>appData</code> also trash the contents of <code>appData->owned</code> and <code>appData->resources</code>. Previously we <code>pushStruct</code> arrays into the memory arena, but it is trashed after we read the appData. The alignment itself is never the problem, <strong>the assumptions that it is happening because of it is the problem.</strong></p><h3 id=a-detour-to-my-backyard>A Detour to My Backyard</h3><p>From my experience, debugging is a process in which you try to investigate why something happens with your limited ideas that could come in mind.
Think of it as you are searching for a hidden lifetime savings buried on your backyard, the problem is, you’re the one that hid it and you don’t remember where you put it, as in a bug where the cause of it is usually yourself, your past-self is a fool and your future-self is forgetful.</p><p>You begin limiting your search with a particular rock on the corner.</p><p>Weird, you don’t remember you had a big rock in your lovely backyard.
You assume is it hidden beneath the rock, because when you check the surroundings area of the rock, the ground is soft, someone must have dug it and store it there recently, and someone is you.</p><p>You know think that you’re first assumptions is correct and thought you’re a genius.</p><p>You then begin digging and digging only to find your dead cat that you’ve buried weeks ago, you then cried deeply and become frustrated, repeat.</p><p>After a lot of time passed, you just realized that you’re savings is not buried on your backyard, it is beneath your pillow that you used at night when you’re weeping sadly about your dead cat. It’s been there all along, closer than you might think.</p><p>See the frustration that happens when finding a root cause of a bug happens because we makes wrong assumptions. So by making assumptions that the bug happens because of memory alignment, I happen to check on the wrong side of things. My assumptions also strengthened by the fact that it happens more on release build. Clearly release build usually do some optimization and more extra work by packing your data, thus a wrong access would cause access violations.</p><h3 id=hold-x-to-give-respect-to-the-cat>Hold X to Give Respect To The Cat</h3><p>There are two ways that I could think of to fix this bug, either by separating the pointers into another struct that holds only those two pointers, or reading and writing the data itself field by field. By separating the struct, the code turned into this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>AppData</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>pad_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>pad_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u32</span> <span class=n>data4</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>OtherData</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>OwnedResource</span><span class=o>*</span> <span class=n>owned</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Resource</span><span class=o>*</span> <span class=n>resources</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AppData</span><span class=o>*</span> <span class=n>appData</span> <span class=o>=</span> <span class=nf>pushStruct</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>AppData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>OtherData</span><span class=o>*</span> <span class=n>otherData</span> <span class=o>=</span> <span class=nf>pushStruct</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>OtherData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>otherData</span><span class=o>-&gt;</span><span class=n>owned</span> <span class=o>=</span> <span class=nf>pushArray</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>ResourceType_Count</span><span class=p>,</span> <span class=n>OwnedResource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>otherData</span><span class=o>-&gt;</span><span class=n>resources</span> <span class=o>=</span> <span class=nf>pushArray</span><span class=p>(</span><span class=o>&amp;</span><span class=n>arena</span><span class=p>,</span> <span class=n>ResourceType_Count</span><span class=p>,</span> <span class=n>Resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>and the other way to fix this, is by changing the serialization code itself</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u16</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>pad_1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u16</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>pad_2</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u32</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>data1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u32</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>data2</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u32</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>data2</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u32</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>data4</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>u32</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>owned</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>OwnedResource</span><span class=p>)</span><span class=o>*</span><span class=n>ResourceType_Count</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fread</span><span class=p>(</span><span class=n>appData</span><span class=o>-&gt;</span><span class=n>resource</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Resource</span><span class=p>)</span><span class=o>*</span><span class=n>ResourceType_Count</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dataFile</span><span class=p>);</span>
</span></span></code></pre></div><p>I happen to choose the later version to fix the problem. In my app, there are a lot places that <code>appData</code> would need to access <code>otherData</code>, and it could changes the way the data passes around the app if I happen to break those two together, so I choose the simplest way.</p><p>As a side note, I probably would change the serialization code into something
described here, they do some cool stuff with serializations.</p><h3 id=putting-the-search-to-a-rest>Putting The Search to a Rest</h3><p>So as a general rule, by gaining a lot of experience, you’ve more likely sharpened your assumptions on a bug. This is why experienced developers tends to know quickly how and why a bug happens. They could easily locate which particular line of code that cause this and makes correct assumptions on where to check.</p><p>One of the books that I like and I would recommend given the chance is <a href=https://www.amazon.com/Art-Craft-Problem-Solving/dp/0471789011>The Art and Craft of Problem Solving</a>. That’ll give you insight if you have a block on how to solve a particular problem and force you either to think creatively or by thinking it from another point of view.</p><p>So for a last riddle, what if I ask you to complete this word but without using the letter ‘E’</p><p><strong>SEQUENC_</strong></p><p>Take your time to think of the answers, and anyway if you haven’t seen <a href=https://handmadehero.org/>Handmadehero</a>, go ahead check it out, you’ll learn a ton there.</p></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/ernesernesto target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/ernesernesto target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2025 .
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg></a><script src=http://ernesernesto.github.io/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>